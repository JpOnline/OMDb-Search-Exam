<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="list-item.html">

<dom-module id="list-view">
  <template>
    <style>
      div{
        box-shadow: 1px 1px 1px 1px;
        background-color: white;
        padding: 15px 30px;
      }
      h1{
        text-align: center;
      }
      a{
        color: inherit;
        text-decoration: none;
      }
    </style>

    <!-- Looks like OBDb is not free anymore, using themoviedb instead -->
    <iron-ajax
      auto
      url="https://api.themoviedb.org/3/search/movie"
      params='{{requestParams}}'
      handle-as="json"
      on-response="handleResponse"
      on-error="handleError"
      debouce-duration="300"
    ></iron-ajax>

    <div>
      <h1>iLabSinc API Test</h1>
      <paper-input label="Movie Search" placeholder="Movie by Title" value="{{requestParams.query}}"></paper-input>
    </div>

    <template is="dom-repeat" items="{{movies}}" as="movie">
      <a href="/detail/{{movie.id}}"><list-item movie-meta-data="{{movie}}"></list-item></a>
    </template>

  </template>
  <script>
    class ListView extends Polymer.Element{
      static get is() { return 'list-view'; }
      static get properties() {
        return {
          requestParams: {
            type: Object,
            value: function(){ return {
              api_key: 'afb4449b08bf540b098d1ed1aa52eba3'
            };}
          },
          movies: {
            type: Array,
            value: function(){return [];}
          }
        };
      }
      handleResponse(e){
        console.log(e);
        try{
          this.set('movies', e.detail.response.results);
        }catch(err){
          console.error('I could not read the movie results, here is the error', err);
          console.error('and here is the event', e);
        }
      }
      handleError(e){
        if(!this.requestParams.query || this.requestParams.query === ''){
          this.set('movies', []);
        }else{
          console.error('iron-ajax error', e.detail);
        }
      }
    }

    customElements.define(ListView.is, ListView);
  </script>
</dom-module >
